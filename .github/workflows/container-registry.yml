name: Deploy Container Registry

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment (dev/uat/sbx/prd)'
        required: true
        type: choice
        options: 
          - dev
          - uat
          - sbx
          - prd
        default: dev

jobs:
  validate-branch:
    uses: ./.github/workflows/validate-branch.yml
    with:
      environment: ${{ github.event.inputs.environment }}

  deploy-acr:
    needs: validate-branch
    uses: ./.github/workflows/bicep-deploy.yml
    with:
      environment: ${{ github.event.inputs.environment }}
      bicep_file: 'infra/container-registry-creation/container-registry.bicep'
      parameters_file: 'infra/container-registry-creation/container-registry-${{ github.event.inputs.environment }}.parameters.json'
      deployment_scope: 'group'
      output_query: 'properties.outputs.acrName.value'
    secrets:
      azure_credentials: ${{ github.event.inputs.environment == 'dev' && secrets.AZURE_CREDENTIALS_DEV || github.event.inputs.environment == 'uat' && secrets.AZURE_CREDENTIALS_UAT || github.event.inputs.environment == 'sbx' && secrets.AZURE_CREDENTIALS_SBX || secrets.AZURE_CREDENTIALS_PRD }}
      resource_group_name: ${{ github.event.inputs.environment == 'dev' && secrets.RESOURCE_GROUP_DEV || github.event.inputs.environment == 'uat' && secrets.RESOURCE_GROUP_UAT || github.event.inputs.environment == 'sbx' && secrets.RESOURCE_GROUP_SBX || secrets.RESOURCE_GROUP_PRD }}
